var e=async({schedule:e},{services:t,database:a,getSchema:r,env:s,logger:i})=>{const{ItemsService:n}=t,o=await r(),c=new Headers,d=`${s.SHISHI_CATALOG_URL}/api/v1/resellers`,l=s.SHISHI_CATALOG_API_USER,u=s.SHISHI_CATALOG_API_PASSWORD;c.set("Authorization","Basic "+btoa(l+":"+u)),c.set("Content-Type","application/json");const S=new n("resellers",{schema:o,database:a}),h=await fetch(d,{headers:c,method:"GET"}),g=await h.json();e("5 4 * * SUN",(async()=>{for(const e of g)try{const t=await S.readByQuery({filter:{buum_uid:{_eq:e.buum_uid}},limit:1}),a=JSON.parse(e),{slug:r,...s}=a;t.length>0?(s.date_updated=(new Date).toISOString(),i.info(`Updating client: ${r}`),await S.updateOne(r,s)):(i.info(`Creating client: ${r}`),await S.createOne({slug:r,...s}))}catch(t){i.error(`Error processing reseller: ${e}`),i.error(t)}})),e("0 2 * * SUN",(async()=>{const e=await S.readByQuery({limit:-1,filter:{status:"published"}});for(const t of e)try{const e=await fetch(`${d}/${t.buum_uid}`,{headers:c,method:"GET"});await e.json()||(console.warn(`Archiving: ${t.slug}`),t.status="archived",t.date_updated=(new Date).toISOString(),await S.updateOne(t.slug,t))}catch(e){i.error(`Error processing reseller: ${t}`),i.error(e)}}))};export{e as default};
